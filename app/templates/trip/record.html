{% extends "base.html" %}

{% block title %}Recording Trip - Best Bike Paths{% endblock %}

{% block content %}
<div class="container-fluid p-3">
    <div class="text-center mb-3">
        <h2 class="text-success">Recording...</h2>
        <div id="timer" class="h4 text-muted">00:00:00</div>
    </div>

    <div class="row g-3 mb-3">
        <div class="col-4">
            <div class="card trip-stat-card">
                <div class="trip-stat-value" id="distance">0.00</div>
                <div class="trip-stat-label">km</div>
            </div>
        </div>
        <div class="col-4">
            <div class="card trip-stat-card">
                <div class="trip-stat-value" id="speed">0.0</div>
                <div class="trip-stat-label">km/h</div>
            </div>
        </div>
        <div class="col-4">
            <div class="card trip-stat-card">
                <div class="trip-stat-value" id="points">0</div>
                <div class="trip-stat-label">points</div>
            </div>
        </div>
    </div>

    <div id="mapContainer" class="map-container mb-3"></div>

    <div class="text-center">
        <button id="stopTripBtn" class="btn btn-danger btn-lg btn-lg-mobile">
            <i class="bi bi-stop-circle"></i> Stop Recording
        </button>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    if (!requireAuth()) {
        throw new Error('Authentication required');
    }

    const activeTripData = localStorage.getItem('activeTrip');
    if (!activeTripData) {
        window.location.href = '/trip/dashboard';
        throw new Error('No active trip');
    }

    const activeTrip = JSON.parse(activeTripData);
    const tripId = activeTrip.tripId;
    const startTime = new Date(activeTrip.startTime);

    let map, pathPolyline, currentMarker;
    let watchId = null;
    let coordinateCount = 0;
    let pathCoordinates = [];

    function initMap() {
        map = L.map('mapContainer').setView([45.4642, 9.1900], 15);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: 'Â© OpenStreetMap contributors'
        }).addTo(map);

        pathPolyline = L.polyline([], {
            color: '#28a745',
            weight: 4,
            opacity: 0.7
        }).addTo(map);
    }

    function updateTimer() {
        const now = new Date();
        const elapsed = Math.floor((now - startTime) / 1000);
        const hours = Math.floor(elapsed / 3600);
        const minutes = Math.floor((elapsed % 3600) / 60);
        const seconds = elapsed % 60;

        document.getElementById('timer').textContent =
            `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
    }

    async function sendCoordinate(latitude, longitude, timestamp, elevation) {
        try {
            await API.trips.addCoordinate(tripId, {
                latitude,
                longitude,
                timestamp,
                elevation
            });
            coordinateCount++;
            document.getElementById('points').textContent = coordinateCount;
        } catch (error) {
            console.error('Failed to send coordinate:', error);
        }
    }

    let coordinateQueue = [];
    let sendInterval;

    function startGPSTracking() {
        if (!('geolocation' in navigator)) {
            showAlert('Geolocation not supported', 'danger');
            return;
        }

        watchId = navigator.geolocation.watchPosition(
            (position) => {
                const lat = position.coords.latitude;
                const lon = position.coords.longitude;
                const elevation = position.coords.altitude;

                pathCoordinates.push([lat, lon]);
                pathPolyline.setLatLngs(pathCoordinates);

                if (currentMarker) {
                    map.removeLayer(currentMarker);
                }
                currentMarker = L.marker([lat, lon]).addTo(map);
                map.setView([lat, lon], map.getZoom());

                coordinateQueue.push({
                    latitude: lat,
                    longitude: lon,
                    timestamp: new Date().toISOString(),
                    elevation: elevation
                });
            },
            (error) => {
                console.error('GPS error:', error);
                showAlert('GPS tracking error', 'warning');
            },
            {
                enableHighAccuracy: true,
                maximumAge: 0,
                timeout: 5000
            }
        );

        sendInterval = setInterval(async () => {
            if (coordinateQueue.length > 0) {
                const coord = coordinateQueue.shift();
                await sendCoordinate(coord.latitude, coord.longitude, coord.timestamp, coord.elevation);
            }
        }, 5000);
    }

    let statsUpdateInterval;

    async function updateStats() {
        try {
            const trip = await API.trips.getDetail(tripId);
            if (trip.totalDistance) {
                document.getElementById('distance').textContent = (trip.totalDistance / 1000).toFixed(2);
            }
            if (trip.averageSpeed) {
                document.getElementById('speed').textContent = (trip.averageSpeed * 3.6).toFixed(1);
            }
        } catch (error) {
            console.error('Failed to update stats:', error);
        }
    }

    document.getElementById('stopTripBtn').addEventListener('click', async () => {
        const btn = document.getElementById('stopTripBtn');
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Stopping...';

        if (watchId) {
            navigator.geolocation.clearWatch(watchId);
        }
        if (sendInterval) {
            clearInterval(sendInterval);
        }
        if (statsUpdateInterval) {
            clearInterval(statsUpdateInterval);
        }

        while (coordinateQueue.length > 0) {
            const coord = coordinateQueue.shift();
            await sendCoordinate(coord.latitude, coord.longitude, coord.timestamp, coord.elevation);
        }

        try {
            const endTime = new Date().toISOString();
            await API.trips.complete(tripId, endTime);

            localStorage.removeItem('activeTrip');
            window.location.href = `/trip/summary/${tripId}`;
        } catch (error) {
            showAlert('Failed to complete trip: ' + error.message, 'danger');
            btn.disabled = false;
            btn.innerHTML = '<i class="bi bi-stop-circle"></i> Stop Recording';
        }
    });

    initMap();
    startGPSTracking();
    setInterval(updateTimer, 1000);
    statsUpdateInterval = setInterval(updateStats, 10000);
    updateStats();
</script>
{% endblock %}
