{% extends "base.html" %}

{% block title %}Trip Details - Best Bike Paths{% endblock %}

{% block content %}
<div class="container-fluid p-3">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2>Trip Details</h2>
        <a href="/trip/history" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left"></i> Back
        </a>
    </div>

    <div id="tripContent">
        <div class="loading-spinner">
            <div class="spinner-border text-success"></div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    if (!requireAuth()) {
        throw new Error('Authentication required');
    }
    
    const tripId = '{{ trip_id }}';

    async function loadTripDetail() {
        try {
            const trip = await API.trips.getDetail(tripId);

            let html = `
                <div class="row g-3 mb-3">
                    <div class="col-6 col-md-3">
                        <div class="card trip-stat-card">
                            <div class="trip-stat-value">${(trip.totalDistance / 1000).toFixed(2)}</div>
                            <div class="trip-stat-label">Distance (km)</div>
                        </div>
                    </div>
                    <div class="col-6 col-md-3">
                        <div class="card trip-stat-card">
                            <div class="trip-stat-value">${formatDuration(trip.duration)}</div>
                            <div class="trip-stat-label">Duration</div>
                        </div>
                    </div>
                    <div class="col-6 col-md-3">
                        <div class="card trip-stat-card">
                            <div class="trip-stat-value">${(trip.averageSpeed * 3.6).toFixed(1)}</div>
                            <div class="trip-stat-label">Avg Speed (km/h)</div>
                        </div>
                    </div>
                    <div class="col-6 col-md-3">
                        <div class="card trip-stat-card">
                            <div class="trip-stat-value">${(trip.maxSpeed * 3.6).toFixed(1)}</div>
                            <div class="trip-stat-label">Max Speed (km/h)</div>
                        </div>
                    </div>
                </div>

                <div class="map-container mb-3" id="mapContainer"></div>

                <div class="row g-3">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-body">
                                <h5 class="card-title">Trip Information</h5>
                                <table class="table table-sm">
                                    <tr>
                                        <td><strong>Start Time:</strong></td>
                                        <td>${formatDateTime(trip.startTime)}</td>
                                    </tr>
                                    <tr>
                                        <td><strong>End Time:</strong></td>
                                        <td>${formatDateTime(trip.endTime)}</td>
                                    </tr>
                                    <tr>
                                        <td><strong>GPS Points:</strong></td>
                                        <td>${trip.coordinates.length}</td>
                                    </tr>
                                </table>
                            </div>
                        </div>
                    </div>

                    ${trip.weather ? `
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-body">
                                    <h5 class="card-title"><i class="bi bi-cloud-sun"></i> Weather</h5>
                                    <table class="table table-sm">
                                        <tr>
                                            <td><strong>Temperature:</strong></td>
                                            <td>${trip.weather.temperature}°C</td>
                                        </tr>
                                        <tr>
                                            <td><strong>Conditions:</strong></td>
                                            <td>${trip.weather.conditions}</td>
                                        </tr>
                                        <tr>
                                            <td><strong>Wind:</strong></td>
                                            <td>${trip.weather.windSpeed} km/h ${trip.weather.windDirection || ''}</td>
                                        </tr>
                                    </table>
                                </div>
                            </div>
                        </div>
                    ` : ''}
                </div>
            `;

            document.getElementById('tripContent').innerHTML = html;

            // Filter out GPS anomalies (points that would require unrealistic speed)
            const filteredCoords = filterGPSAnomalies(trip.coordinates);
            
            const map = L.map('mapContainer').setView([filteredCoords[0].latitude, filteredCoords[0].longitude], 14);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors'
            }).addTo(map);

            const pathCoords = filteredCoords.map(c => [c.latitude, c.longitude]);
            L.polyline(pathCoords, {
                color: '#28a745',
                weight: 4,
                opacity: 0.7
            }).addTo(map);

            L.marker([filteredCoords[0].latitude, filteredCoords[0].longitude], {
                icon: L.divIcon({
                    className: 'start-marker',
                    html: '<i class="bi bi-geo-alt-fill text-success" style="font-size: 30px;"></i>',
                    iconSize: [30, 30]
                })
            }).addTo(map).bindPopup('Start');

            const lastCoord = filteredCoords[filteredCoords.length - 1];
            L.marker([lastCoord.latitude, lastCoord.longitude], {
                icon: L.divIcon({
                    className: 'end-marker',
                    html: '<i class="bi bi-flag-fill text-danger" style="font-size: 30px;"></i>',
                    iconSize: [30, 30]
                })
            }).addTo(map).bindPopup('End');

            map.fitBounds(L.polyline(pathCoords).getBounds(), { padding: [50, 50] });
        } catch (error) {
            document.getElementById('tripContent').innerHTML = `
                <div class="alert alert-danger">Failed to load trip details: ${error.message}</div>
            `;
        }
    }

    // Filter out GPS anomalies - points that would require unrealistic movement
    function filterGPSAnomalies(coordinates) {
        if (coordinates.length < 2) return coordinates;
        
        const MAX_SPEED_MS = 25; // 25 m/s = 90 km/h max realistic cycling speed
        const filtered = [coordinates[0]]; // Always keep first point
        
        for (let i = 1; i < coordinates.length; i++) {
            const prev = filtered[filtered.length - 1];
            const curr = coordinates[i];
            
            // Calculate distance using Haversine formula
            const R = 6371000; // Earth radius in meters
            const lat1 = prev.latitude * Math.PI / 180;
            const lat2 = curr.latitude * Math.PI / 180;
            const dLat = (curr.latitude - prev.latitude) * Math.PI / 180;
            const dLon = (curr.longitude - prev.longitude) * Math.PI / 180;
            
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                      Math.cos(lat1) * Math.cos(lat2) *
                      Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            const distance = R * c;
            
            // Calculate time difference
            const prevTime = new Date(prev.timestamp).getTime();
            const currTime = new Date(curr.timestamp).getTime();
            const timeDiff = (currTime - prevTime) / 1000; // seconds
            
            // Skip if time difference is invalid
            if (timeDiff <= 0) {
                continue;
            }
            
            // Calculate speed
            const speed = distance / timeDiff;
            
            // Only include point if speed is realistic
            if (speed <= MAX_SPEED_MS) {
                filtered.push(curr);
            } else {
                console.log(`Filtered GPS anomaly: ${speed.toFixed(1)} m/s (${(speed*3.6).toFixed(1)} km/h)`);
            }
        }
        
        return filtered;
    }

    loadTripDetail();
</script>
{% endblock %}
