{% extends "base.html" %}

{% block title %}Route Details - Best Bike Paths{% endblock %}

{% block content %}
<div class="container-fluid p-3">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2>Route Details</h2>
        <a href="/search" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left"></i> Back to Search
        </a>
    </div>

    <div id="routeContent">
        <div class="loading-spinner">
            <div class="spinner-border text-success"></div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    const routeId = '{{ route_id }}';

    async function loadRouteDetails() {
        try {
            const route = await API.paths.getDetail(routeId);

            let html = `
                <div class="card mb-3">
                    <div class="card-body">
                        <h4>${route.name || 'Route'}</h4>
                        ${route.description ? `<p class="text-muted">${route.description}</p>` : ''}
                        <div class="row mt-3">
                            <div class="col-md-3">
                                <div class="text-center">
                                    <div class="h3 text-success">${formatDistance(route.totalDistance)}</div>
                                    <div class="small text-muted">Total Distance</div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="text-center">
                                    <div class="h3 text-success">${route.score.toFixed(1)}/10</div>
                                    <div class="small text-muted">Accessibility Score</div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="text-center">
                                    <div class="h3 text-success">${route.segments.length}</div>
                                    <div class="small text-muted">Segments</div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="text-center">
                                    <div class="h3 text-success">${route.dataSource}</div>
                                    <div class="small text-muted">Source</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="map-container mb-3" id="mapContainer"></div>

                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title mb-3">Segments</h5>
            `;

            route.segments.forEach((segment, index) => {
                const badgeClass = getStatusBadgeClass(segment.status);
                html += `
                    <div class="segment-item status-${segment.status.toLowerCase()} mb-3">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <h6>Segment ${index + 1} ${segment.streetName ? `- ${segment.streetName}` : ''}</h6>
                                <span class="badge ${badgeClass}">${segment.status.replace('_', ' ')}</span>
                            </div>
                        </div>
                        ${segment.obstacles.length > 0 ? `
                            <div class="mt-2">
                                <strong>Obstacles:</strong>
                                <ul class="mb-0 mt-1">
                                    ${segment.obstacles.map(obs => `
                                        <li>
                                            <span class="badge bg-danger">${obs.type}</span>
                                            <span class="badge bg-warning text-dark">${obs.severity}</span>
                                            ${obs.description ? `- ${obs.description}` : ''}
                                        </li>
                                    `).join('')}
                                </ul>
                            </div>
                        ` : ''}
                    </div>
                `;
            });

            html += `
                    </div>
                </div>
            `;

            document.getElementById('routeContent').innerHTML = html;

            const map = L.map('mapContainer').setView([route.segments[0].startLatitude, route.segments[0].startLongitude], 14);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: 'Â© OpenStreetMap contributors'
            }).addTo(map);

            route.segments.forEach((segment, index) => {
                const color = getStatusColor(segment.status);
                L.polyline([
                    [segment.startLatitude, segment.startLongitude],
                    [segment.endLatitude, segment.endLongitude]
                ], {
                    color: color,
                    weight: 5,
                    opacity: 0.8
                }).addTo(map).bindPopup(`Segment ${index + 1}: ${segment.status}`);

                segment.obstacles.forEach(obstacle => {
                    L.marker([obstacle.latitude, obstacle.longitude], {
                        icon: L.divIcon({
                            className: 'obstacle-marker',
                            html: '<i class="bi bi-exclamation-triangle-fill text-danger" style="font-size: 24px;"></i>',
                            iconSize: [24, 24]
                        })
                    }).addTo(map)
                    .bindPopup(`
                        <strong>${obstacle.type}</strong><br>
                        Severity: ${obstacle.severity}<br>
                        ${obstacle.description ? obstacle.description : ''}
                    `);
                });
            });

        } catch (error) {
            document.getElementById('routeContent').innerHTML = `
                <div class="alert alert-danger">Failed to load route details: ${error.message}</div>
            `;
        }
    }

    loadRouteDetails();
</script>
{% endblock %}
